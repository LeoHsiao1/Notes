# 插件

k8s 的软件生态比较开放，有很多插件。
<!-- k8s 有多种扩展方式 -->


## API 规范

- k8s 内部的一些组件通过 API 相互调用，并且定义了 API 规范。
  - 采用 gRPC 协议进行通信。
  - API 规范使得 k8s 组件之间比较解耦，有利于模块化设计、更换组件。
  - 例如 k8s 容器运行时的 API 规范是 CRI ，如果一个插件符合该 API 规范，则可以替换 k8s 默认的容器运行时组件。

- 容器运行时接口（Container Runtime Interface ，CRI）
  - ：供 kubelet 调用担任容器运行时的组件，从而管理容器、镜像。
  - 早期的 k8s 默认采用 Docker 作为容器引擎，因为 Docker 是当时最流行的容器引擎。
    - 后来 k8s 社区制定了 CRI 规范，但 Docker 不符合该规范。因此 k8s 社区开发了一个符合 CRI 规范的 dockershim 模块，通过它间接调用 dockerd ，从而管理容器。
    - 2020 年， k8s 社区认为维护 dockershim 模块比较麻烦，因此弃用 dockershim 模块，建议用户改用 containerd 或 CRI-O 作为 CRI 组件。
      - 不使用 dockershim 模块，就不能通过 docker 命令查看、管理 kubelet 部署的容器。但用 docker build 命令构建的镜像符合 OCI 标准，依然可以被 containerd 或 CRI-O 运行。
    - 2021 年，Mirantis 公司和 Docker 公司联合开发 cri-dockerd 项目，用于继续实现 dockershim 的功能，从而不必用户更换 CRI 组件。

- 容器网络接口（Container Network Interface ，CNI）
  - ：供 k8s 管理容器的网络。

- 容器存储接口（Container Storage Interface ，CSI）
  - ：供 k8s 管理容器的存储层。
  - k8s 本身提供了 hostPath、ConfigMap 等类型的 volume 。而一些第三方的存储程序可通过 CSI 接口接入 k8s 集群，提供一些其它类型的 volume 。

- 设备插件（Device Plugins）
  - ：允许将主机上的 GPU、FPGA 等设备接入 k8s 进行管理。

## API Aggregation

- apiserver 进程中设计了一个聚合层（Aggregation Layer），允许用户注册一些自定义的 API 服务器，被 apiserver 反向代理，从而在逻辑上聚合成一个 API 服务器。
  - 优点：方便扩展 apiserver ，添加自定义的 API 。

- 例如 metrics-server 是一个给 k8s 增加 CPU、内存使用率等监控指标的工具，采用 API Aggregation 的方式工作。原理如下：
  1. 按 API 规范开发 metrics-server 程序，然后在 k8s 中以 Deployment 方式部署，并绑定 Service 。
  2. 创建一个 APIService 类型的资源，将 metrics-server 注册为一个 API 服务器。
      ```yml
      apiVersion: apiregistration.k8s.io/v1
      kind: APIService
      metadata:
        name: v1beta1.metrics.k8s.io  # API 服务器的名称，格式为 ${version}.${group}
      spec:
        group: metrics.k8s.io         # API 服务器的组名
        groupPriorityMinimum: 100     # 该 group 的优先级
        insecureSkipTLSVerify: true   # apiserver 向该 API 服务器发送 HTTPS 请求时，是否跳过 TLS 认证
        service:                      # 让 apiserver 将请求发送到该 k8s service ，从而调用该 API 服务器
          name: metrics-server
          namespace: kube-system
          port: 443
        version: v1beta1              # API 服务器的版本
        versionPriority: 100          # 该 version 在当前 group 全部版本中的优先级
      ```
  3. 客户端发送 HTTPS 请求给 apiserver 。如果请求指向的 URI 为 `/apis/metrics.k8s.io/v1beta1/...` ，则 apiserver 会将请求转发给 metrics-server 这个 APIService 。

- 用户可创建多个 APIService 资源。
  - 如果多个 APIService 划分到同一个 group ，只是 version 不同，则代表同一种 API 服务器的不同实例。
  - 整个 group 的优先级，取决于该 group 中 groupPriorityMinimum 最高的那个 APIService 。
