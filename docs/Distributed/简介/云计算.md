# 云计算

## 简介

- 云计算（Cloud Computing）是 21 世纪兴起的一种计算机使用模式。
  - 特点：
    - 网络服务：用户自己不持有计算机，而是通过网络，使用某些公司提供的计算机。这些公司统称为云计算公司。
    - 按需计费：云计算公司通常将计算机租给大量用户，按小时或按月计费，而不是买断制。
    - 虚拟化：云计算公司通常不直接提供计算机裸机，而是通过 KVM 等技术，提供不同规格的虚拟计算机，从而满足用户的不同需求。例如 1核CPU+1G内存的小机型，64核CPU+128G内存的大机型。
    - 云计算公司除了提供计算机，通常还提供数据库、CDN 等多种类型的产品服务，统称为云服务。
    - 云计算公司内部，通常使用 OpenStack 平台或自研平台来管理大量云服务，统称为云平台。一个云计算公司可能拥有多个云平台。
    - 云计算公司对外，通常提供一个 Web 网站，供用户在上面选购云服务。
  - 例：
    - 按传统模式，如果用户想部署一个 Web 网站，则需要自己购买服务器裸机，然后安装操作系统、Web 软件。
    - 按云计算模式，用户可以在云平台上租一台服务器，然后安装 Web 软件。甚至可以不用服务器，通过 FaaS 模式部署 Web 网站。
  - 优点：
    - 用户不必买断计算机等设备，可按需计费，适合短时需求。
    - 用户不必自建机房，节省了场地、电力、维护等大量成本。
    - 云平台通常在世界多个位置搭建了机房，允许用户在这些机房租用服务器，方便用户部署国际性的 Web 服务。
  - 缺点：
    - 长时间租用云服务，可能成本比自建机房还高。

## 云服务

云平台可能提供很多种云服务，按自动化程度分为几类：
- IaaS
  - ：基础设施即服务（Infrastructure as a Service），云平台只提供一些基础设施，比如服务器裸机、虚拟服务器、VPC 。
- PaaS
  - ：平台即服务（Platform as a Service），提供一个平台，用户在上面编写代码，然后平台会自动构建、部署、监控，并提供数据库等依赖软件。
  - 例如 GitHub 平台允许用户编写代码，然后由 GitHub Actions 自动构建、部署，属于功能较少的 PaaS 产品。
- SaaS
  - ：软件即服务（Software as a Service），云平台提供一些软件供用户使用，例如已部署的 MySQL、Redis 。
  - 优点：
    - 用户不必亲自部署、运维这些软件，节省了学习成本、人力。
  - 缺点：
    - 成本更高，不如用户亲自创建服务器、部署软件。
    - 通常只允许用户访问这些软件的 TCP/UDP 端口，不允许用户修改这些软件的部署配置。
  - SaaS 比 PaaS 的自动化程度更高，不过通常都会使用。例如用 PaaS 模式开发业务程序，调用 SaaS 模式的数据库。
- BaaS
  - ：后端即服务（Backend as a Service），云平台提供一些常用的后端服务，比如身份认证、消息通知，不必用户编写这些后端代码。
- FaaS
  - ：函数即服务（Function as a Service），与 PaaS 相似，但用户可以只编写一个函数的代码，不必编写整个程序的代码。
  - 例如云平台提供一个部署在容器中的 Flask 模板项目，用户在其中增加一个函数的代码，即可增加一个 HTTP API 。
  - 与 PaaS 相比，FaaS 偏向单个 API ，粒度更小，更灵活，但只能满足 HTTP API 等少量需求。

## 云平台

租用云服务的用户，可能是一个人，也可能是一个公司。
- 一个公司内可能有多个人需要使用云服务，通常这样划分权限：
  - 首先创建一个主账号，负责付费，并担任管理员。
  - 主账号之下可以创建多个子账号，权限较小，分配给不同员工使用。
  - 主账号及其子账号，属于同一个租户（tenant）。
  - 云平台通常支持创建 APIKEY 类型的子账号，不供人类使用，而是供程序调用云平台的 API 。

按租户数量，将云平台分为几类：
- 公共云（Public Cloud）
  - ：多个租户共用一个云平台。
  - 缺点：不同租户使用的云服务，在逻辑上、网络上进行了隔离，但物理上可能共用同一台服务器，可能相互影响。不过大客户也可申请专用服务器。
- 私有云（Private Cloud）
  - ：单个租户独享一个云平台。
  - 缺点：通常比公有云的功能少，软件版本也不会及时更新。
  - 例：
    - 公司 A 原本有一个自建机房，按传统模式使用。然后搭建云平台，改造为云计算模式，就算一个私有云。
    - 公司 A 搭建一个云平台（可以位于自建机房、其它公司的机房），给自己使用，这属于私有云。
    - 公司 A 搭建一个云平台，卖给公司 B 单独使用，这属于公司 B 的私有云，只是由公司 A 托管。
    - 公司 A 搭建一个云平台，卖给多个公司共用，这属于公有云。
- 混合云（Hybrid Cloud）
  - ：指单个租户，混合使用一个私有云（通常是自建机房）和一个公有云。
  - 例：
    - 公司 A 正在将自建机房中的服务，迁移部署到公有云，所以暂时处于混合云模式。
    - 公司 A 将大部分服务部署在公有云，但一些私密数据必须存储在私有云，所以长期处于混合云模式。
  - 缺点：同一个云内的服务，通常采用内网通信，而跨云通信只能采用公网，成本高、速度低。
- 多云（Multicloud）
  - ：指单个租户混合使用多个云平台。
  - 例：
    - 公司 A 追求更高的服务可用性，于是在多个云平台上部署了服务。当一个云平台故障时，其它云平台依然能工作。
    - 公司 A 追求更高的性价比，于是同时使用多个云平台。哪个云平台打折促销、性价比更高，就暂时将服务部署在那里。
  - 缺点：为了将服务迁移部署到不同云平台，需要对每个云平台解耦，只使用 VPS 等通用的云服务。

公有云举例：
- 亚马逊云（Amazon Web Services，AWS）
  - AWS 公司是 Amazon 的子公司。2006 年，AWS 公司推出云服务 S3、EC2 ，开启了云计算时代，此后世界上出现了许多云计算公司。
  - 2022 年，全球市场份额最大的公有云依次是 AWS、Azure、GCP 。
- 微软云（Azure）
  - 优点：适配微软公司的产品，比如 Windows 系统、Office 软件、.net 语言。
  - 缺点：Web UI 简陋，不方便用户使用。
- 谷歌云（Google Cloud Platform，GCP）
- 阿里云（Alibaba Cloud）
  - 公司成立于 2009 年，是中国最早成立的公有云，占据的中国市场份额最大。
- 腾讯云（Tencent Cloud）
- 华为云（Huawei Cloud）

## 相关概念

- VPS（Virtual Private Servers ，虚拟专用服务器）
  - ：又称为虚拟机。可以在一台物理服务器上通过 Hypervisor 技术运行多个虚拟服务器，分配给多个用户私自使用。
- CVM（Cloud Virtual Machine ，云虚拟机）
  - ：指云平台提供的 VPS 。
  - 有的云平台将它称为 ECS（Elastic Compute Service ，弹性计算服务器）。
- VPC（Virtual Private Cloud ，虚拟私有云）
  - ：云平台上一种小的逻辑分区，管理一组 VPS ，专门供某个用户或企业使用，像一个 Paas 层的私有云。
- VDC（Virtual Data Center ，虚拟数据中心）
  - ：云平台上一种大的逻辑分区，管理一组 VPS、CPU、内存、硬盘等资源，像一个 IaaS 层的私有云。
- OpenStack
  - ：一个开源的云平台框架，采用 Python 开发，常用于搭建云平台并管理 CVM 等资源，提供 IaaS 服务。
  - OpenStack 只是一个框架，用户需要自行实现计算、存储、网络等组件。例如存储后端通常采用 Ceph 。
- CNCF（Cloud Native Computing Foundation，云原生计算基金会）
  - 2015 年，Linux 基金会下属的 CNCF 基金会成立，旨在推动云原生技术的发展。
  - 负责管理 containerd、k8s、CoreDNS、etcd、Prometheus 等项目。
- 云原生（Cloud Native）
  - ：一种系统架构，旨在充分利用云平台的优势。
  - 比如为了利用 k8s 的优势，要把传统服务改造成容器化部署，最好实现无状态。
  - 特点：
    - 容器化部署
    - 微服务架构
    - 服务网格
    - 不可变基础设施：尽量不修改程序的运行环境，而是根据虚拟机镜像、容器镜像创建运行环境。这样控制运行环境，容易复制、迁移、升级、回滚。
    - 声明式 API ：比如用户可通过 YAML 文件声明 k8s 对象的期望状态，k8s 会自动达到期望状态，不需要用户指导过程。
- Serverless
  - ：一种设计模式，又称为无服务器架构。是让软件开发人员专注于代码开发，不必关注在服务器上如何构建、部署、运维。
  - 云计算的 BaaS 和 FaaS 都属于 Serverless 。
  - 例如微信小程序实现了 Serverless ，开发者写好代码之后就可以直接发布。

## VPC 组网

- 一个 VPC 中包含的各个 VPS ，默认位于同一个局域网，可以使用内网 IP 相互通信。
  - 不同 VPC 之间网络隔离，需要添加路由表才能相互通信。
  - 一个 VPC 中还可以划分多个子网，但这些子网之间并没有网络隔离。

- 安全组：相当于防火墙规则，用于控制主机的出入流量。
  - 主机的出入流量先受到主机上 firewalld 防火墙的控制，再受到云平台安全组的控制。
  - 可以给一个或多个 VPS 绑定一个或多个安全组。

VPC 内部的主机与外部通信的方法：
- 可以给 VPC 添加 NAT 网关，让 VPC 能与公网通信。此时网络包的流向为：VPC 主机 → NAT 网关 → 公网主机 。
- 可以给 VPC 添加 VPN ，让 VPC 能与本地网络通信。此时网络包的流向为：VPC 主机 → VPC 网关 → 公网中转 → VPN 服务器 → 公网中转 → 本地网关 → 本地主机 。
- 可以给 VPC 中的一个主机绑定外部某个网络的 IP ，使其能够与该网络的主机通信。这个 IP 在不用的时候可以解绑，因此称为 "弹性 IP" 。
  - 例如，使用弹性公网 IP ，就可以让 VPC 中的主机与公网通信。
  - 一个弹性 IP 只能让 VPC 中的一个主机与外部通信，而一个 NAT 网关可以让 VPC 中的所有主机与外部通信。
  - 如果将一个弹性公网 IP 给 NAT 网关使用，就可以让 VPC 中的所有主机都能访问公网。

下图是腾讯云的网络架构：

![](./frame.jpg)

- CVM 部署在 region1 的 VPC 中，不具备公网 IP ，不能主动与公网通信，对外网不可见。
- 当公网中的主机主动访问集群时，要将请求发送到 LBS 的公网 IP 地址、80 端口。
  - LBS 会将从 80 端口收到的流量转发给 VPC 中的几个 CVM——将数据包的目的 IP、目的端口改为某台 CVM 的内网 IP、端口。CVM 收到该包之后，会把它转发到相应的容器端口。
  - 当 CVM 处理完请求之后，会将回复的数据包通过 LBS 返回给公网的主机。
- 当 CVM 主动访问公网时，要将请求发送到 NAT 网关，由 NAT 网关进行代理。
- 当 CVM1 主动访问同一个 VPC 内的另一个 CVM2 时，需要先配置从 CVM1 到 CVM2 的路由表。
- 当 CVM1 主动访问另一个 VPC 内的 CVM 时，需要先通过 "对等连接" 功能将两个 VPC 的网络连通，然后配置两个 VPC 之间的路由表。
- 在腾讯云购买一个 VPS 之后，如果需要连通公网，有两种计费模式：
  - 按带宽计费 ：限制公网出带宽的最大值，即 VPS 发向公网的流量。
    - 公网入带宽与公网出带宽相等，但至少会分配 10 Mbps ，因为能共享机房的入带宽。
  - 按流量计费 ：每隔 1 小时，按使用的公网出流量计费，而公网入流量不计费。

- VPC 本身是一层虚拟网络，只能模拟 OSI 网络层及以上的功能，不能模拟数据链路层、物理层的大部分功能，在这方面不如物理机房。
  - 公有云平台一般不支持传播 ARP、BGP 消息。用户需要调用公有云的 API ，才能分配自定义 IP 、修改路由规则。
  - 有的公有云平台将所有 VPS 的 IP 地址都固定解析到网关的 Mac 地址，由网关转发流量。
