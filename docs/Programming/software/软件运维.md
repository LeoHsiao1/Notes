# 软件运维

- 当一个软件部署、交付之后，就会正式交给用户使用。此时进入软件过程的最后一个环节，该环节通常命名为"运行与维护"（operation and maintenance），简称为"运维"（ops）。
  - 为什么命名为运维？因为软件运行时，可能发生故障，需要实施一些维护措施。

## 运维技术

软件行业经过多年发展，运维技术可分为几大类：
- 手工运维
  - ：传统的运维工作，通常是人工手动执行。
  - 缺点：
    - 工作效率低。
    - 人工操作容易出错。
- 自动化运维
  - ：编写程序（通常是 shell 脚本）来自动执行一些重复性的运维工作。
  - 缺点：
    - 编写程序需要一定人力成本。
- AIOps
  - ：基于人工智能来自动化运维。
  - 优点：
    - 自动化程度更高。shell 脚本只能执行固定的运维规则，而 AIOps 能通过机器学习，从海量运维数据中，总结出新的运维规则。
  - 缺点：
    - 人工智能可能出错。

## 部署环境

假设某公司研发了一个 Web 网站，通常存在多个部署环境：

- 开发环境（dev）
  - ：允许开发工程师自由部署某些服务模块，自由调试，不必让测试工程师检查。
  - 为了安全，通常不暴露到公网。

- 测试环境（test）
  - ：模拟生产环境，部署了全部模块，用于测试。
  - 为了安全，通常不暴露到公网。

- 生产环境（prod）
  - ：供正式用户使用，通常暴露到公网。
  - 为了稳定，新版本的服务模块，应该先在测试环境检查之后，才部署到生产环境。

- 预发布环境（pre）
  - ：一个严格的测试环境。各个服务模块的软件版本、配置文件、数据尽量与生产环境一致。
  - 对于复杂的 Web 网站，普通的测试环境可能难以模拟生产环境，比如配置文件随意、编造假数据。这样可能无法发现一些 bug ，因此建议增加一个预发布环境。

## 发版方式

假设某公司研发了一个 Web 网站，需要从版本 v1 更新部署到 v2 ，常见的几种发版方式如下：

- 直接发布
  - 流程：
    1. 先停止旧版本的服务。
    2. 再部署新版本的服务。
  - 优点：
    - 发布过程简单。
  - 缺点：
    - 中途没有正常运行的服务，导致网站的服务中断一段时间，严重影响用户的使用。
    - 如果新服务有问题，需要重启旧服务，又导致服务中断一段时间。

- 蓝绿发布（blue-green release）
  - 前提条件：
    - 用户的访问流量不直接发送到服务，而是先发送到网关（比如 Nginx ），然后网关将流量反向代理到服务。
  - 流程：
    1. 先部署一组新版本的服务（称为蓝组）。
    2. 修改网关的配置，原本将用户的访问流量转发到旧服务，现在改为转发到新服务。该过程称为流量迁移。
    3. 等新服务正常运行之后，再停止旧服务（称为绿组）。
  - 优点：
    - 发布过程简单。
    - 如果新服务有问题，可以立即将访问流量转发到旧服务，实现一键回滚。
  - 缺点：
    - 中途同时部署两组服务，因此需要两倍的服务器资源，成本较大。
  - 迁移 HTTP 类型的流量时，用户新发送的 HTTP 请求会转发给新服务。但用户可能之前发送了 HTTP 请求，已经转发给旧服务处理，尚未返回 HTTP 响应。为了避免中断旧 HTTP 请求，需要增加以下措施：
    - 保持旧 HTTP 请求的网络链路（比如保持旧的 TCP 连接），使得旧服务返回 HTTP 响应时，网关能正常转发给用户。
    - 等旧 HTTP 请求全部结束，才停止旧服务。

- 滚动发布
  - ：分阶段更新服务，而不是一次更新全部。
  - 比如一个服务部署了多个实例，先更新 20% 的实例，等更新部署成功了，才更新下一批 20% 的实例。
  - 优点：
    - 类似蓝绿发布，但一次只更新部分服务，因此不需要两倍的服务器资源，成本较低。
  - 缺点：
    - 如果发现异常，可以恢复到上一阶段，称为回滚（rollback）。但不能直接恢复到最初状态。

- 金丝雀发布（canary release）
  - ：在生产环境更新服务，先给少部分用户试用。试用正常之后，再给全部用户使用。
  - 在中国又称为灰度发布。
  - 优点：
    - 测试环境不能完全模拟生产环境，因此新版本的服务可能在测试环境正常工作，在生产环境却发现问题。而灰度发布可减轻这种问题，实现更可靠的测试。
  - 缺点：
    - 可能导致少部分用户不满。
